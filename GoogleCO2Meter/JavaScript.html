<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
  function getData() {
    $(function() {
      // Call the server here to retrieve any information needed to build the page.
      google.script.run
         .withSuccessHandler(function(contents) {
              // Respond to success conditions here.
              updateDisplay(contents);
            })
         .withFailureHandler(function(msg) {
              // Respond to failure conditions here.
              $('#main-heading').text(msg);
              $('#main-heading').addClass("error");
              $('#error-message').show();
            })
         .getContent();
    });
  };
  
  // timer 10 sec
  $(document).ready(function(){ 
    getData();
    setInterval('getData()',10000);  
  });  

  /**
   * Updates display.
   *
   * @param {Object} contents none)
   *
   */
  function updateDisplay(contents) {
    $('#main-heading').hide();
    $('#error-message').hide();
    $('#results').empty();

    var c = $.parseJSON(contents);
    var panel = '<div class="row"><div class="col-xs-6 col-md-4"> <div class="panel panel-default"><div class="panel-heading">' +
      '<h3 class="panel-title">CO2 meter online data</h3></div><div class="panel-body">';
    if ($.isNumeric(c.idate) && (c.idate > 0)) {
      var co2levelclass = '';
      if (c.co2level > 800) co2levelclass = 'warning';
      if (c.co2level > 2000) co2levelclass = 'danger';
      
      var now = new Date();
      var tsec = ((now - new Date('2000-01-01T00:00:00Z')) / 1000) >> 0;
      tsec = tsec - now.getTimezoneOffset() * 60; // correct timezone
      
      var dateclass = '';
      if (tsec - c.idate > 180) dateclass = 'warning';
      if (tsec - c.idate > 600) dateclass = 'danger';
      
      panel = panel + '<table class="table table-striped">' + 
          '<tr class="' + co2levelclass + '"><td>CO2 level</td><td>' + c.co2level + 'ppm</td></tr>' +
          '<tr><td>Temperature</td><td>' + c.temperature + '&deg;C</td></tr>' +
          '<tr><td>Humidity</td><td>' + c.humidity + '%</td></tr>' +
          '<tr class="' + dateclass + '"><td>Updated</td><td>' + c.date + ' (' + (tsec - c.idate) + ' sec ago)</td></tr></table>';
    } else {
      panel = panel + 'No data from datalogger.';
    }
    panel = panel + '</div></div></div></div>';

    $('#results').append(panel);
    
  }
</script>
